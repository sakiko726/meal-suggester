import streamlit as st
import pandas as pd
from datetime import datetime, timedelta

st.set_page_config(page_title="é£Ÿäº‹ã‚µãƒãƒ¼ãƒˆAI", layout="wide")

# --------------------------------------------------------
# 0) åˆæœŸåŒ–
# --------------------------------------------------------
if "meals" not in st.session_state:
    st.session_state.meals = []

if "phase" not in st.session_state:
    st.session_state.phase = None


# --------------------------------------------------------
# 1) ç”Ÿç†å‘¨æœŸå…¥åŠ› â†’ åµèƒæœŸ/æ’åµæœŸ/é»„ä½“æœŸ è‡ªå‹•åˆ¤å®š
# --------------------------------------------------------
st.header("ğŸ”® ç”Ÿç†å‘¨æœŸãƒã‚§ãƒƒã‚¯")

last_period = st.date_input("ğŸ©¸ æœ€çµ‚ç”Ÿç†é–‹å§‹æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")

if last_period:
    today = datetime.now().date()
    cycle_day = (today - last_period).days

    if cycle_day <= 7:
        phase = "ğŸ©¸ æœˆçµŒæœŸï¼ˆ1ã€œ7æ—¥ï¼‰"
    elif cycle_day <= 14:
        phase = "ğŸŒ± åµèƒæœŸï¼ˆ8ã€œ14æ—¥ï¼‰â†’ ä»£è¬ãŒå®‰å®šã—ã¦ç—©ã›ã‚„ã™ã„ï¼"
    elif cycle_day == 15 or cycle_day == 16:
        phase = "ğŸ’˜ æ’åµæœŸï¼ˆ15ã€œ16æ—¥ï¼‰â†’ è‚Œãƒ„ãƒ¤æœ€å¼·âœ¨ ä½“æ¸©ä¸Šæ˜‡å‰"
    elif cycle_day <= 28:
        phase = "ğŸ”¥ é»„ä½“æœŸï¼ˆ17ã€œ28æ—¥ï¼‰â†’ ã‚€ãã¿ãƒ»é£Ÿæ¬²çˆ†ä¸ŠãŒã‚Šæ³¨æ„âš ï¸"
    else:
        phase = "â³ æ¬¡ã®ç”Ÿç†ãŒè¿‘ã„ or ç”Ÿç†å‘¨æœŸãŒé•·ã‚"

    st.session_state.phase = phase
    st.success(f"ã‚ãªãŸã®ä»Šæ—¥ã®çŠ¶æ…‹ã¯ **{phase}** ã§ã™ï¼")


# --------------------------------------------------------
# 2) æ€§æ ¼AIé¸æŠï¼ˆå„ªã—ã„å§‰ / å³ã—ã‚ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ / å†·é™åŒ»è€…ï¼‰
# --------------------------------------------------------
st.header("ğŸ­ ã‚ãªãŸã®ã‚µãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸ã‚“ã§ã­ï¼")

mode = st.radio(
    "ã©ã®AIã«å¿œæ´ã•ã‚ŒãŸã„ï¼Ÿ",
    ("ğŸ’› å„ªã—ã„ãŠå§‰ã•ã‚“", "ğŸ”¥ å³ã—ã‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ¼", "ğŸ‘“ å†·é™ãªåŒ»è€…")
)

def ai_reply(text):
    if mode == "ğŸ’› å„ªã—ã„ãŠå§‰ã•ã‚“":
        return f"ğŸ’› ãˆã‚‰ã™ãã‚‹ã‚ˆã€œï¼{text} ã»ã‚“ã¨ã«ç”Ÿãã¦ã‚‹ã ã‘ã§å¤©æ‰ã ã—å¯æ„›ã„ï¼ğŸ¥¹âœ¨"
    elif mode == "ğŸ”¥ å³ã—ã‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ¼":
        return f"ğŸ”¥ {text} ã¾ã ã¾ã ï¼è…¹ç­‹30å›ã„ã‘ã‚‹ã£ã—ã‚‡ï¼ï¼ŸğŸ’ªğŸ˜¤"
    else:
        return f"ğŸ‘“ {text} â€¦â€¦ã§ã™ã­ã€‚å¼•ãç¶šãè¨˜éŒ²ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ğŸ“Š"


# --------------------------------------------------------
# 3) é£Ÿæãƒ‡ãƒ¼ã‚¿
# --------------------------------------------------------
FOODS = {
    "é¶ã‚€ã­è‚‰": {"kcal": 1.1, "P": 0.23, "F": 0.02, "C": 0},
    "åµ": {"kcal": 1.55, "P": 0.13, "F": 0.11, "C": 0.01},
    "ã‚ªãƒ¼ãƒˆãƒŸãƒ¼ãƒ«": {"kcal": 3.8, "P": 0.13, "F": 0.07, "C": 0.68},
    "ã•ã¤ã¾ã„ã‚‚": {"kcal": 1.3, "P": 0.01, "F": 0, "C": 0.3},
    "ç™½ç±³": {"kcal": 1.68, "P": 0.025, "F": 0.003, "C": 0.37},
    "ã‚¢ãƒœã‚«ãƒ‰": {"kcal": 1.87, "P": 0.02, "F": 0.19, "C": 0.02},
    "è±†è…": {"kcal": 0.56, "P": 0.05, "F": 0.03, "C": 0.02},
    "ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼": {"kcal": 0.33, "P": 0.028, "F": 0.003, "C": 0.07},
}


# --------------------------------------------------------
# 4) é£Ÿäº‹ç™»éŒ² & æ „é¤Šè¨ˆç®—
# --------------------------------------------------------
st.header("ğŸ¥— é£Ÿäº‹ã‚’ç™»éŒ²ã™ã‚‹")

food = st.selectbox("é£Ÿæã‚’é¸æŠ", list(FOODS.keys()))
weight = st.number_input("ã‚°ãƒ©ãƒ æ•°", 0, 500, 100)

if st.button("â• è¿½åŠ "):
    data = FOODS[food]
    entry = {
        "food": food,
        "gram": weight,
        "kcal": data["kcal"] * weight,
        "P": data["P"] * weight,
        "F": data["F"] * weight,
        "C": data["C"] * weight,
    }
    st.session_state.meals.append(entry)
    st.success(ai_reply(f"{food} ã‚’ {weight}g è¨˜éŒ²ã—ãŸã‚ˆï¼"))


# --------------------------------------------------------
# 5) ä»Šæ—¥ã®è¨˜éŒ²ä¸€è¦§ + PFCåˆè¨ˆ
# --------------------------------------------------------
st.header("ğŸ“˜ ä»Šæ—¥ã®è¨˜éŒ²")

if len(st.session_state.meals) > 0:
    df = pd.DataFrame(st.session_state.meals)
    st.dataframe(df)

    total = df[["kcal", "P", "F", "C"]].sum()

    st.subheader("ğŸ€ ä»Šæ—¥ã®åˆè¨ˆ")
    st.write(f"ğŸ”¥ **kcal:** {total.kcal:.0f}")
    st.write(f"ğŸ’ª **Protein:** {total.P:.1f} g")
    st.write(f"ğŸ¥‘ **Fat:** {total.F:.1f} g")
    st.write(f"ğŸ **Carbs:** {total.C:.1f} g")

else:
    st.info("ã¾ã é£Ÿäº‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ğŸ˜Œ")


# --------------------------------------------------------
# 6) PFCã®åã‚Š â†’ æ „é¤Šåˆ†æ + æ¬¡ã®é£Ÿäº‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹
# --------------------------------------------------------
st.header("ğŸ§ª æ „é¤Šãƒãƒ©ãƒ³ã‚¹åˆ†æ")

if len(st.session_state.meals) > 0:
    p = total.P
    f = total.F
    c = total.C

    message = ""

    if p < 60:
        message += "ğŸ“ **ã‚¿ãƒ³ãƒ‘ã‚¯è³ªãŒä¸è¶³æ°—å‘³ï¼** é¶ã‚€ã­ãƒ»åµãƒ»ã‚®ãƒªã‚·ãƒ£ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆãªã©ã‚’æ¬¡ã®é£Ÿäº‹ã§è¿½åŠ ã—ã‚ˆã†ï¼\n"
    if f < 40:
        message += "ğŸ¥‘ **è„‚è³ªãŒå°‘ãªã‚ï¼** ã‚¢ãƒœã‚«ãƒ‰ãƒ»ãƒŠãƒƒãƒ„ãƒ»ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«ã§èª¿æ•´ã—ã‚ˆï¼\n"
    if c < 150:
        message += "ğŸ  **ç‚­æ°´åŒ–ç‰©ãŒè¶³ã‚Šã¦ãªã„ã‹ã‚‚ï¼** ã•ã¤ã¾ã„ã‚‚ãƒ»ã‚ªãƒ¼ãƒˆãƒŸãƒ¼ãƒ«ãŒã‚ªã‚¹ã‚¹ãƒ¡ï¼\n"
    if message == "":
        message = "âœ¨PFCãƒãƒ©ãƒ³ã‚¹å®Œç’§ï¼æ¬¡ã®é£Ÿäº‹ã‚‚ãã®èª¿å­ï¼"

    st.success(ai_reply(message))


# --------------------------------------------------------
# 7) ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ã®é£Ÿæ¬²äºˆæ¸¬ï¼ˆç”Ÿç†å‘¨æœŸï¼‰
# --------------------------------------------------------
st.header("ğŸŒ™ é£Ÿæ¬²ãƒ»ã‚€ãã¿äºˆæ¸¬")

phase = st.session_state.phase
if phase:

    if "åµèƒæœŸ" in phase:
        st.info("ğŸŒ± åµèƒæœŸã¯ä»£è¬ãŒå®‰å®šã—ã¦ã„ã¦ç—©ã›ã‚„ã™ã„ã‚ˆï¼é£Ÿæ¬²ã‚‚è½ã¡ç€ãæ™‚æœŸâœ¨")
    elif "æ’åµæœŸ" in phase:
        st.info("ğŸ’˜ æ’åµæœŸã¯è‚Œãƒ„ãƒ¤æœ€å¼·ï¼ãŸã ã—å°‘ã—ã‚€ãã¿ã‚„ã™ã„æ™‚æœŸã‹ã‚‚ğŸ‘€")
    elif "é»„ä½“æœŸ" in phase:
        st.warning("ğŸ”¥ é»„ä½“æœŸã¯é£Ÿæ¬²ã‚¢ãƒƒãƒ—ï¼†ã‚€ãã¿ã‚„ã™ã„ï¼ç‚­æ°´åŒ–ç‰©ã¨è„‚è³ªã‚’é£Ÿã¹ã™ãæ³¨æ„âš ï¸")
    else:
        st.write("ğŸ©¸ ä»Šæ—¥ã®çŠ¶æ…‹ãŒåæ˜ ã•ã‚Œã¦ã‚‹ã‚ˆï¼")


# --------------------------------------------------------
# å®Œäº†
# --------------------------------------------------------
st.write("âœ¨ è¨˜éŒ²ãŠã¤ã‹ã‚Œã•ã¾ï¼")
