import streamlit as st
import pandas as pd
from datetime import datetime, timedelta

st.title("AIã‚³ãƒ¼ãƒä»˜ã é£Ÿäº‹ & ä½“èª¿ã‚µãƒãƒ¼ãƒˆã‚¢ãƒ—ãƒª ğŸ’›")

# =========================================================
# åˆæœŸåŒ–
# =========================================================
if "meals" not in st.session_state:
    st.session_state.meals = []

if "settings" not in st.session_state:
    st.session_state.settings = {
        "kcal_target": 1450,
        "protein_target": 100,
        "fat_target": 35,
        "carbs_target": 160,
        "coach_tone": "å„ªã—ã„ãŠå§‰ã•ã‚“",
        "hormone_phase": "ãªã—"
    }

s = st.session_state.settings

# =========================================================
# ğŸ©¸ ç”Ÿç†å‘¨æœŸãƒã‚§ãƒƒã‚¯
# =========================================================
st.header("ğŸ©¸ ç”Ÿç†å‘¨æœŸãƒã‚§ãƒƒã‚¯")

period_start = st.date_input("ç›´è¿‘ã®ç”Ÿç†é–‹å§‹æ—¥ã‚’å…¥åŠ›ã—ã¦ã­")
cycle_length = st.number_input("å¹³å‡ç”Ÿç†å‘¨æœŸï¼ˆæ—¥ï¼‰", min_value=20, max_value=40, value=28)
period_length = st.number_input("ç”Ÿç†æœŸé–“ã®æ—¥æ•°", min_value=3, max_value=10, value=5)

today = datetime.now().date()

phase = "ä¸æ˜"
coach_msg = ""

if period_start:
    days_passed = (today - period_start).days % cycle_length

    if days_passed < period_length:
        phase = "æœˆçµŒæœŸï¼ˆMenstruationï¼‰"
        coach_msg = "ä»Šæ—¥ã¯ã‚†ã£ãã‚Šä¼‘ã‚“ã§ã­â€¦ç”Ÿãã¦ã‚‹ã ã‘ã§å‰ã„ã‚ˆğŸ’›"

    elif days_passed < 14:
        phase = "åµèƒæœŸï¼ˆFollicularï¼‰"
        coach_msg = "ä»£è¬ãŒä¸ŠãŒã‚Šã‚„ã™ã„æ™‚æœŸï¼ã“ã“ã‹ã‚‰ä¸€ç·’ã«ãƒšãƒ¼ã‚¹ä¸Šã’ã‚ˆğŸ’›"

    elif days_passed == 14:
        phase = "æ’åµæœŸï¼ˆOvulationï¼‰"
        coach_msg = "é­…åŠ›MAXã®æ™‚æœŸâœ¨ æ°—åˆ†ã‚‚è‚Œã‚‚èª¿å­ã‚ˆããªã‚ŠãŒã¡ï¼"

    else:
        phase = "é»„ä½“æœŸï¼ˆLutealï¼‰"
        coach_msg = "ã‚€ãã¿ãƒ»é£Ÿæ¬²UPã—ãŒã¡ï¼ç”˜ã„ç‰©ã»ã—ããªã‚‹ã®ã¯ãƒ›ãƒ«ãƒ¢ãƒ³ã®ã›ã„ğŸ«"

    st.subheader(f"ğŸ“Œ ç¾åœ¨ã®ã‚ãªãŸã®ãƒ•ã‚§ãƒ¼ã‚ºï¼š **{phase}**")
    st.write(coach_msg)

# =========================================================
# 1) é£Ÿæãƒ‡ãƒ¼ã‚¿ï¼ˆ60å“ï¼‰
# =========================================================
FOODS = {
    "ä¸»é£Ÿ": {
        "ç™½ã”ã¯ã‚“": {"kcal": 168, "P": 2.5, "F": 0.3, "C": 37},
        "ã‚ªãƒ¼ãƒˆãƒŸãƒ¼ãƒ«": {"kcal": 380, "P": 13.7, "F": 6.2, "C": 69},
        "é£Ÿãƒ‘ãƒ³": {"kcal": 260, "P": 9, "F": 4, "C": 45},
        "ã†ã©ã‚“": {"kcal": 105, "P": 2.6, "F": 0.4, "C": 21},
        "ãã°": {"kcal": 120, "P": 4.8, "F": 1, "C": 24},
    },
    "è‚‰ãƒ»é­š": {
        "é¶ã‚€ã­è‚‰": {"kcal": 165, "P": 31, "F": 4, "C": 0},
        "é¶ã•ã•ã¿": {"kcal": 105, "P": 24, "F": 0.8, "C": 0},
        "ç‰›èµ¤èº«": {"kcal": 182, "P": 21, "F": 10, "C": 0},
        "è±šãƒ­ãƒ¼ã‚¹": {"kcal": 240, "P": 19, "F": 17, "C": 0},
        "ã‚µãƒ¼ãƒ¢ãƒ³": {"kcal": 200, "P": 20, "F": 13, "C": 0},
        "ãƒ„ãƒŠç¼¶ï¼ˆæ°´ç…®ï¼‰": {"kcal": 102, "P": 23.5, "F": 0.8, "C": 0},
    },
    "åµãƒ»å¤§è±†": {
        "åµ": {"kcal": 151, "P": 12.3, "F": 10.3, "C": 0.7},
        "è±†è…": {"kcal": 56, "P": 4.9, "F": 3, "C": 1.1},
        "ç´è±†": {"kcal": 200, "P": 16.5, "F": 10, "C": 12},
        "åšæšã’": {"kcal": 150, "P": 10, "F": 10, "C": 3},
    },
    "é‡èœ": {
        "ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼": {"kcal": 33, "P": 4.3, "F": 0.5, "C": 7},
        "ãƒˆãƒãƒˆ": {"kcal": 18, "P": 0.7, "F": 0.1, "C": 3.8},
        "ãƒ¬ã‚¿ã‚¹": {"kcal": 15, "P": 1.0, "F": 0.2, "C": 2.8},
        "ã«ã‚“ã˜ã‚“": {"kcal": 37, "P": 0.8, "F": 0.2, "C": 9},
        "ã»ã†ã‚Œã‚“è‰": {"kcal": 20, "P": 2.1, "F": 0.4, "C": 3.1},
    },
    "æœç‰©": {
        "ãƒãƒŠãƒŠ": {"kcal": 86, "P": 1.1, "F": 0.2, "C": 23},
        "ã‚Šã‚“ã”": {"kcal": 52, "P": 0.2, "F": 0.1, "C": 14},
        "ã„ã¡ã”": {"kcal": 34, "P": 0.9, "F": 0.1, "C": 8},
        "ã¿ã‹ã‚“": {"kcal": 45, "P": 0.6, "F": 0.2, "C": 12},
    },
    "è„‚è³ªãƒ»ä¹³è£½å“": {
        "ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ": {"kcal": 62, "P": 3.6, "F": 3, "C": 5.2},
        "ãƒãƒ¼ã‚º": {"kcal": 356, "P": 22, "F": 29, "C": 2},
        "ãƒŠãƒƒãƒ„": {"kcal": 600, "P": 20, "F": 50, "C": 20},
        "ã‚¢ãƒœã‚«ãƒ‰": {"kcal": 187, "P": 2.1, "F": 18, "C": 6},
    },
    "ã‚¹ã‚¤ãƒ¼ãƒ„": {
        "ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ": {"kcal": 558, "P": 7, "F": 34, "C": 55},
        "ã‚¢ã‚¤ã‚¹": {"kcal": 180, "P": 3, "F": 8, "C": 23},
        "ã‚¯ãƒƒã‚­ãƒ¼": {"kcal": 490, "P": 6, "F": 23, "C": 66},
        "ã‚±ãƒ¼ã‚­": {"kcal": 430, "P": 5, "F": 24, "C": 50},
    }
}


# =========================================================
# ğŸ½ é£Ÿäº‹å…¥åŠ›
# =========================================================
st.header("ğŸ½ é£Ÿäº‹å…¥åŠ›ï¼ˆã‚°ãƒ©ãƒ ã§OKï¼ï¼‰")

selected_food = st.selectbox("é£Ÿã¹ãŸã‚‚ã®ã‚’é¸ã¶", food_names)
grams = st.number_input("é£Ÿã¹ãŸé‡ï¼ˆgï¼‰", min_value=1, max_value=2000, value=100)

if st.button("ã‚«ãƒ­ãƒªãƒ¼è¨ˆç®—"):
    total = FOODS[selected_food] * (grams / 100)
    st.subheader(f"ğŸ‘‰ **{selected_food}ï¼š{total:.1f} kcal**")

if st.button("è¿½åŠ ã™ã‚‹ ğŸ½ï¸"):
    kcal = FOODS[selected_food] * (grams / 100)

    st.session_state.meals.append({
        "time": datetime.now().strftime("%H:%M"),
        "food": selected_food,
        "grams": grams,
        "kcal": kcal,
    })
    st.success("è¿½åŠ ã—ã¾ã—ãŸï¼âœ¨")

# =========================================================
# 5) ä»Šæ—¥ã®è¨˜éŒ²
# =========================================================
st.subheader("ğŸ“˜ ä»Šæ—¥ã®è¨˜éŒ²")
if len(st.session_state.meals) > 0:
    df = pd.DataFrame(st.session_state.meals)
    st.dataframe(df)

    total = df[["kcal", "P", "F", "C"]].sum()

    st.markdown("### ğŸ€ ä»Šæ—¥ã®åˆè¨ˆ")
    st.write(f"ğŸ”¥ **kcal:** {total.kcal:.0f} / {s['kcal_target']}")
    st.write(f"ğŸ’ª **Protein:** {total.P:.1f} / {s['protein_target']}")
    st.write(f"ğŸ¥‘ **Fat:** {total.F:.1f} / {s['fat_target']}")
    st.write(f"ğŸ **Carbs:** {total.C:.1f} / {s['carbs_target']}")

# =========================================================
# 6) AIã‚³ãƒ¼ãƒã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹
# =========================================================
if st.button("AIã‚³ãƒ¼ãƒã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’èã ğŸ§"):
    tone = s["coach_tone"]
    phase = s["hormone_phase"]

    advice = ""

    # --- å£èª¿åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ---
    if tone == "å„ªã—ã„ãŠå§‰ã•ã‚“":
        advice += "ğŸ’› ãˆã‚‰ã™ãã‚‹ã‚ˆâ€¦ä»Šæ—¥ã‚‚ã¡ã‚ƒã‚“ã¨é£Ÿäº‹è¨˜éŒ²ã—ã¦ã‚‹ã ã‘ã§æœ¬å½“ã«ã‹ã£ã“ã„ã„â€¦ï¼\n"
    elif tone == "ä½“è‚²ä¼šç³»":
        advice += "ğŸ”¥ ãŠã„ï¼ã¾ã ã¾ã ã„ã‘ã‚‹ã ã‚ï¼Ÿï¼ã‚ˆãã‚„ã£ã¦ã‚‹ãï¼\n"
    else:  # å†·é™ãªåŒ»è€…
        advice += "ğŸ‘“ ãµã‚€ã€ä»Šæ—¥ã®çµæœã‚’è§£æã—ã¾ã™ã­ã€‚\n"

    # --- æ „é¤Šä¸è¶³ã«ã‚ˆã‚‹é£Ÿæ¬²åˆ†æ ---
    if total.P < s["protein_target"] * 0.6:
        advice += "- ã‚¿ãƒ³ãƒ‘ã‚¯è³ªä¸è¶³ â†’ ç”˜ã„ã‚‚ã®æ¬²ã—ããªã‚‹å¯èƒ½æ€§é«˜ã„ã§ã™ã€‚\n"

    # --- ãƒ›ãƒ«ãƒ¢ãƒ³åˆ†æ ---
    if phase == "é»„ä½“æœŸ":
        advice += "- é»„ä½“æœŸã¯é£Ÿæ¬²ãŒè‡ªç„¶ã«å¼·ããªã‚‹æ™‚æœŸã§ã™ã€‚ã‚€ãã¿ã‚‚å‡ºã‚„ã™ã„ã§ã™ã€‚\n"
    if phase == "æ’åµæœŸ":
        advice += "- æ’åµæœŸã¯ä»£è¬ãŒé«˜ããªã£ã¦ä½“æ¸©ã‚‚ä¸ŠãŒã‚Šã¾ã™ã€‚\n"
    if phase == "æœˆçµŒ":
        advice += "- æœˆçµŒä¸­ â†’ é‰„åˆ†ãƒ»ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‚’æ„è­˜ã™ã‚‹ã¨ä½“èª¿ãŒå®‰å®šã—ã¾ã™ã€‚\n"

    # --- æ¬¡ã®é£Ÿäº‹ææ¡ˆ ---
    advice += "\nğŸ™ **æ¬¡ã®é£Ÿäº‹ã¯ã“ã‚ŒãŒãŠã™ã™ã‚ï¼**\n"

    if total.P < s["protein_target"]:
        advice += "- é¶ã‚€ã­è‚‰ / åµ / ãƒ„ãƒŠç¼¶ / ã‚®ãƒªã‚·ãƒ£ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ\n"
    if total.C < s["carbs_target"] * 0.6:
        advice += "- ã•ã¤ã¾ã„ã‚‚ / ã‚ªãƒ¼ãƒˆãƒŸãƒ¼ãƒ« / ãƒãƒŠãƒŠ\n"
    if total.F < s["fat_target"] * 0.6:
        advice += "- ã‚¢ãƒœã‚«ãƒ‰ / ãƒŠãƒƒãƒ„\n"

    st.info(advice)
   

  # -------------------------
    # ğŸ”¥ ã‚³ãƒ¼ãƒã®ã‚³ãƒ¡ãƒ³ãƒˆ
    # -------------------------

    st.write("---")
    st.subheader("ğŸ¤– ä»Šæ—¥ã®ã‚³ãƒ¼ãƒã‚³ãƒ¡ãƒ³ãƒˆ")

    if coach == "å„ªã—ã„ãŠå§‰ã•ã‚“ğŸ’›":
        st.write("ğŸ’› ã‚ˆãé£Ÿã¹ãŸã­ã€œï¼ç„¡ç†ã—ãªãã¦ã„ã„ã‚ˆã€ç”Ÿãã¦ã‚‹ã ã‘ã§å®Œç’§ï¼")
        st.write("ğŸ’› æ¬¡ã®é£Ÿäº‹ã‚‚ä¸€ç·’ã«è€ƒãˆã‚ˆï¼Ÿ")

    elif coach == "å³ã—ã‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ¼ğŸ’ª":
        st.write("ğŸ’ª ã¾ã ã¾ã ã ï¼æ¬¡ã¯ã‚¿ãƒ³ãƒ‘ã‚¯è³ªè¿½åŠ ï¼è…¹ç­‹30å›ã„ã‘ã‚‹ãï¼ï¼")
        st.write("ğŸ”¥ ãŒã£ã¤ã ãœï¼ï¼")

    else:  # åŒ»è€…
        st.write("ğŸ‘“ ãµã‚€ã€èˆˆå‘³æ·±ã„ãƒ‡ãƒ¼ã‚¿ã§ã™ã­ã€‚")
        st.write("ğŸ‘“ æ¬¡ã®é£Ÿäº‹ã§ã¯â—‹â—‹ã‚’è¿½åŠ ã™ã‚‹ã¨ã•ã‚‰ã«å®‰å®šã—ã¾ã™ã­ã€‚")

# =========================================================
# âš™ï¸ ã‚µã‚¤ãƒ‰ãƒãƒ¼è¨­å®š
# =========================================================
with st.sidebar:
    st.header("âš™ï¸ è¨­å®šï¼ˆç›®æ¨™å€¤ã‚’å¤‰ãˆã‚‰ã‚Œã‚‹ã‚ˆï¼‰")

    s["kcal_target"] = st.number_input("ç›®æ¨™ kcal", value=s["kcal_target"])
    s["protein_target"] = st.number_input("ç›®æ¨™ P", value=s["protein_target"])
    s["fat_target"] = st.number_input("ç›®æ¨™ F", value=s["fat_target"])
    s["carbs_target"] = st.number_input("ç›®æ¨™ C", value=s["carbs_target"])

    st.markdown("### ğŸ©º ç”Ÿç†å‘¨æœŸ")
    s["hormone_phase"] = st.selectbox("ãƒ›ãƒ«ãƒ¢ãƒ³çŠ¶æ…‹", ["ãªã—", "æœˆçµŒ", "åµèƒæœŸ", "æ’åµæœŸ", "é»„ä½“æœŸ"])

    st.markdown("### ğŸ¤ ã‚³ãƒ¼ãƒã®ã‚¿ã‚¤ãƒ—")
    s["coach_tone"] = st.selectbox("ã‚³ãƒ¼ãƒã®å£èª¿", ["å„ªã—ã„ãŠå§‰ã•ã‚“", "å³ã—ã‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ¼", "åŒ»è€…"])
